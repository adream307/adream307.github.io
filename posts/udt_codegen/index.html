<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="9-自定义数据类型上的 Codegen" /><meta name="author" content="adream307" /><meta property="og:locale" content="en_US" /><meta name="description" content="本篇文章是这个系列的最后一篇文章，我们介绍如何在 UDT 上做 Codegen，和前文类似， Codegen 实现的自定义函数要求如下: 该函数接受两个 my_point 类型的参数作为输入 参数名记为 x，y 函数输出 my_point(x.x+y.x, x.y+y.y)" /><meta property="og:description" content="本篇文章是这个系列的最后一篇文章，我们介绍如何在 UDT 上做 Codegen，和前文类似， Codegen 实现的自定义函数要求如下: 该函数接受两个 my_point 类型的参数作为输入 参数名记为 x，y 函数输出 my_point(x.x+y.x, x.y+y.y)" /><link rel="canonical" href="https://adream307.github.io/posts/udt_codegen/" /><meta property="og:url" content="https://adream307.github.io/posts/udt_codegen/" /><meta property="og:site_name" content="I have a adream" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-06-09T08:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="9-自定义数据类型上的 Codegen" /><meta name="twitter:site" content="@adream307" /><meta name="twitter:creator" content="@adream307" /><meta name="google-site-verification" content="Z5OtiJgdgFPkmVvyaqXAconYzwftcOvxgr9jz0is5zM" /> <script type="application/ld+json"> {"description":"本篇文章是这个系列的最后一篇文章，我们介绍如何在 UDT 上做 Codegen，和前文类似， Codegen 实现的自定义函数要求如下: 该函数接受两个 my_point 类型的参数作为输入 参数名记为 x，y 函数输出 my_point(x.x+y.x, x.y+y.y)","url":"https://adream307.github.io/posts/udt_codegen/","@type":"BlogPosting","headline":"9-自定义数据类型上的 Codegen","dateModified":"2020-06-09T08:00:00+08:00","datePublished":"2020-06-09T08:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://adream307.github.io/posts/udt_codegen/"},"author":{"@type":"Person","name":"adream307"},"@context":"https://schema.org"}</script><title>9-自定义数据类型上的 Codegen | I have a adream</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-180680198-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-180680198-1'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/ms-icon-310x310.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">I have a adream</a></div><div class="site-subtitle font-italic">adream307</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/adream307" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/adream307" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['adream307','163.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>9-自定义数据类型上的 Codegen</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>9-自定义数据类型上的 Codegen</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 9, 2020, 8:00 AM +0800" > Jun 9, 2020 <i class="unloaded">2020-06-09T08:00:00+08:00</i> </span> by <span class="author"> adream307 </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2287 words">12 min</span></div></div><div class="post-content"><p>本篇文章是这个系列的最后一篇文章，我们介绍如何在 <code class="language-plaintext highlighter-rouge">UDT</code> 上做 <code class="language-plaintext highlighter-rouge">Codegen</code>，和<a href="../udt_udf_example/">前文</a>类似， <code class="language-plaintext highlighter-rouge">Codegen</code> 实现的自定义函数要求如下:</p><ul><li>该函数接受两个 <code class="language-plaintext highlighter-rouge">my_point</code> 类型的参数作为输入<li>参数名记为 <code class="language-plaintext highlighter-rouge">x，y</code><li>函数输出 <code class="language-plaintext highlighter-rouge">my_point(x.x+y.x, x.y+y.y)</code></ul><h2 id="codegen">Codegen</h2><p>和<a href="../codegen_example/">前文</a>类似， <code class="language-plaintext highlighter-rouge">Codegen</code> 实现的自定义函数也是从 <code class="language-plaintext highlighter-rouge">Expression</code> 继承，并实现 <code class="language-plaintext highlighter-rouge">doGenCode</code> 方法。<code class="language-plaintext highlighter-rouge">doGenCode</code> 也按照 <code class="language-plaintext highlighter-rouge">nullable</code> 的值分为两部分，完整核心代码如下：</p><div class="language-scala highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre><td class="rouge-code"><pre><span class="k">case</span> <span class="k">class</span> <span class="nc">my_foo</span><span class="o">(</span><span class="n">inputExpr</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Expression</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Expression</span> <span class="k">with</span> <span class="nc">ExpectsInputTypes</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="nf">nullable</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="nf">inputExpr</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="py">nullable</span> <span class="o">||</span> <span class="nf">inputExpr</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="py">nullable</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">eval</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">InternalRow</span><span class="o">)</span><span class="k">:</span> <span class="kt">Any</span> <span class="o">=</span> <span class="o">???</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">dataType</span><span class="k">:</span> <span class="kt">DataType</span> <span class="o">=</span> <span class="k">new</span> <span class="n">my_point_udt</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">inputTypes</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">AbstractDataType</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="k">new</span> <span class="n">my_point_udt</span><span class="o">,</span> <span class="k">new</span> <span class="n">my_point_udt</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">children</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Expression</span><span class="o">]</span> <span class="k">=</span> <span class="n">inputExpr</span>

  <span class="k">override</span> <span class="k">protected</span> <span class="k">def</span> <span class="nf">doGenCode</span><span class="o">(</span><span class="n">ctx</span><span class="k">:</span> <span class="kt">CodegenContext</span><span class="o">,</span> <span class="n">ev</span><span class="k">:</span> <span class="kt">ExprCode</span><span class="o">)</span><span class="k">:</span> <span class="kt">ExprCode</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">import</span> <span class="nn">org.apache.spark.sql.catalyst.expressions.codegen._</span>
    <span class="k">import</span> <span class="nn">org.apache.spark.sql.catalyst.expressions.codegen.Block._</span>

    <span class="k">val</span> <span class="nv">left_expr</span> <span class="k">=</span> <span class="nf">inputExpr</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">right_expr</span> <span class="k">=</span> <span class="nf">inputExpr</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">left_code</span> <span class="k">=</span> <span class="nv">left_expr</span><span class="o">.</span><span class="py">genCode</span><span class="o">(</span><span class="n">ctx</span><span class="o">)</span>
    <span class="k">val</span> <span class="nv">right_code</span> <span class="k">=</span> <span class="nv">right_expr</span><span class="o">.</span><span class="py">genCode</span><span class="o">(</span><span class="n">ctx</span><span class="o">)</span>

    <span class="nf">if</span> <span class="o">(</span><span class="n">nullable</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="nv">nullSafeEval</span> <span class="k">=</span>
        <span class="nv">left_code</span><span class="o">.</span><span class="py">code</span> <span class="o">+</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">nullSafeExec</span><span class="o">(</span><span class="nv">left_expr</span><span class="o">.</span><span class="py">nullable</span><span class="o">,</span> <span class="nv">left_code</span><span class="o">.</span><span class="py">isNull</span><span class="o">)</span> <span class="o">{</span>
          <span class="nv">right_code</span><span class="o">.</span><span class="py">code</span> <span class="o">+</span> <span class="nv">ctx</span><span class="o">.</span><span class="py">nullSafeExec</span><span class="o">(</span><span class="nv">right_expr</span><span class="o">.</span><span class="py">nullable</span><span class="o">,</span> <span class="nv">right_code</span><span class="o">.</span><span class="py">isNull</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">s</span><span class="s">"""
               |${ev.isNull} = false; // resultCode could change nullability.
               |${CodeGenerator.javaType(DoubleType)} ${ev.value}_x = ${left_code.value}.getDouble(0) + ${right_code.value}.getDouble(0);
               |${CodeGenerator.javaType(DoubleType)} ${ev.value}_y = ${left_code.value}.getDouble(1) + ${right_code.value}.getDouble(1);
               |org.apache.spark.sql.myfunctions.my_point ${ev.value}_p = new org.apache.spark.sql.myfunctions.my_point(${ev.value}_x, ${ev.value}_y);
               |org.apache.spark.sql.myfunctions.my_point_udt ${ev.value}_u = new org.apache.spark.sql.myfunctions.my_point_udt();
               |${ev.value} = ${ev.value}_u.serialize(${ev.value}_p);
               |"""</span><span class="o">.</span><span class="py">stripMargin</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="nv">ev</span><span class="o">.</span><span class="py">copy</span><span class="o">(</span><span class="n">code</span> <span class="k">=</span>
        <span class="n">code</span><span class="s">"""
              boolean ${ev.isNull} = true;
              ${CodeGenerator.javaType(ArrayType(DoubleType, false))} ${ev.value} = null;
              $nullSafeEval
            """</span>
      <span class="o">)</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="nv">ev</span><span class="o">.</span><span class="py">copy</span><span class="o">(</span><span class="n">code</span> <span class="k">=</span>
        <span class="n">code</span><span class="s">"""
              ${left_code.code}
              ${right_code.code}
              ${CodeGenerator.javaType(DoubleType)} ${ev.value}_x = ${left_code.value}.getDouble(0) + ${right_code.value}.getDouble(0);
              ${CodeGenerator.javaType(DoubleType)} ${ev.value}_y = ${left_code.value}.getDouble(1) + ${right_code.value}.getDouble(1);
              org.apache.spark.sql.myfunctions.my_point ${ev.value}_p = new org.apache.spark.sql.myfunctions.my_point(${ev.value}_x, ${ev.value}_y);
              org.apache.spark.sql.myfunctions.my_point_udt ${ev.value}_u = new org.apache.spark.sql.myfunctions.my_point_udt();
              ${CodeGenerator.javaType(ArrayType(DoubleType, false))} ${ev.value} = ${ev.value}_u.serialize(${ev.value}_p);
            """</span><span class="o">,</span> <span class="nc">FalseLiteral</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>和<a href="../codegen_example/">前文</a> <code class="language-plaintext highlighter-rouge">SparkSQL</code> 内置数据类型的 <code class="language-plaintext highlighter-rouge">Codegen</code> 略有不同，在 <code class="language-plaintext highlighter-rouge">UDT</code> 的 <code class="language-plaintext highlighter-rouge">Codegen</code> 中, 最后赋值给变量 <code class="language-plaintext highlighter-rouge">${ev.value}</code> 的是 <code class="language-plaintext highlighter-rouge">my_point</code> 的序列化，而不是 <code class="language-plaintext highlighter-rouge">my_point</code>。</p><h2 id="程序输出">程序输出</h2><p>完整代码见 <a href="https://github.com/adream307/SparkSQLWithCodegen/tree/master/code/udt_codegen">https://github.com/adream307/SparkSQLWithCodegen/tree/master/code/udt_codegen</a>，处理 <code class="language-plaintext highlighter-rouge">null</code> 的 Codegen 代码如下：</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
</pre><td class="rouge-code"><pre><span class="cm">/* 001 */</span> <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">generate</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">references</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 002 */</span>   <span class="k">return</span> <span class="k">new</span> <span class="nc">GeneratedIteratorForCodegenStage1</span><span class="o">(</span><span class="n">references</span><span class="o">);</span>
<span class="cm">/* 003 */</span> <span class="o">}</span>
<span class="cm">/* 004 */</span>
<span class="cm">/* 005 */</span> <span class="c1">// codegenStageId=1</span>
<span class="cm">/* 006 */</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GeneratedIteratorForCodegenStage1</span> <span class="kd">extends</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">BufferedRowIterator</span> <span class="o">{</span>
<span class="cm">/* 007 */</span>   <span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">references</span><span class="o">;</span>
<span class="cm">/* 008 */</span>   <span class="kd">private</span> <span class="n">scala</span><span class="o">.</span><span class="na">collection</span><span class="o">.</span><span class="na">Iterator</span><span class="o">[]</span> <span class="n">inputs</span><span class="o">;</span>
<span class="cm">/* 009 */</span>   <span class="kd">private</span> <span class="n">scala</span><span class="o">.</span><span class="na">collection</span><span class="o">.</span><span class="na">Iterator</span> <span class="n">rdd_input_0</span><span class="o">;</span>
<span class="cm">/* 010 */</span>   <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeRowWriter</span><span class="o">[]</span> <span class="n">rdd_mutableStateArray_0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeRowWriter</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
<span class="cm">/* 011 */</span>   <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">[]</span> <span class="n">rdd_mutableStateArray_1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">[</span><span class="mi">5</span><span class="o">];</span>
<span class="cm">/* 012 */</span>
<span class="cm">/* 013 */</span>   <span class="kd">public</span> <span class="nf">GeneratedIteratorForCodegenStage1</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">references</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 014 */</span>     <span class="k">this</span><span class="o">.</span><span class="na">references</span> <span class="o">=</span> <span class="n">references</span><span class="o">;</span>
<span class="cm">/* 015 */</span>   <span class="o">}</span>
<span class="cm">/* 016 */</span>
<span class="cm">/* 017 */</span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">scala</span><span class="o">.</span><span class="na">collection</span><span class="o">.</span><span class="na">Iterator</span><span class="o">[]</span> <span class="n">inputs</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 018 */</span>     <span class="n">partitionIndex</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
<span class="cm">/* 019 */</span>     <span class="k">this</span><span class="o">.</span><span class="na">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">;</span>
<span class="cm">/* 020 */</span>     <span class="n">rdd_input_0</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
<span class="cm">/* 021 */</span>     <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeRowWriter</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">64</span><span class="o">);</span>
<span class="cm">/* 022 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 023 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 024 */</span>     <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeRowWriter</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">96</span><span class="o">);</span>
<span class="cm">/* 025 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 026 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 027 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 028 */</span>
<span class="cm">/* 029 */</span>   <span class="o">}</span>
<span class="cm">/* 030 */</span>
<span class="cm">/* 031 */</span>   <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processNext</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
<span class="cm">/* 032 */</span>     <span class="k">while</span> <span class="o">(</span> <span class="n">rdd_input_0</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
<span class="cm">/* 033 */</span>       <span class="nc">InternalRow</span> <span class="n">rdd_row_0</span> <span class="o">=</span> <span class="o">(</span><span class="nc">InternalRow</span><span class="o">)</span> <span class="n">rdd_input_0</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
<span class="cm">/* 034 */</span>       <span class="o">((</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">metric</span><span class="o">.</span><span class="na">SQLMetric</span><span class="o">)</span> <span class="n">references</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="cm">/* numOutputRows */</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="cm">/* 035 */</span>       <span class="kt">boolean</span> <span class="n">rdd_isNull_1</span> <span class="o">=</span> <span class="n">rdd_row_0</span><span class="o">.</span><span class="na">isNullAt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="cm">/* 036 */</span>       <span class="nc">ArrayData</span> <span class="n">rdd_value_1</span> <span class="o">=</span> <span class="n">rdd_isNull_1</span> <span class="o">?</span>
<span class="cm">/* 037 */</span>       <span class="kc">null</span> <span class="o">:</span> <span class="o">(</span><span class="n">rdd_row_0</span><span class="o">.</span><span class="na">getArray</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
<span class="cm">/* 038 */</span>       <span class="kt">boolean</span> <span class="n">rdd_isNull_2</span> <span class="o">=</span> <span class="n">rdd_row_0</span><span class="o">.</span><span class="na">isNullAt</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="cm">/* 039 */</span>       <span class="nc">ArrayData</span> <span class="n">rdd_value_2</span> <span class="o">=</span> <span class="n">rdd_isNull_2</span> <span class="o">?</span>
<span class="cm">/* 040 */</span>       <span class="kc">null</span> <span class="o">:</span> <span class="o">(</span><span class="n">rdd_row_0</span><span class="o">.</span><span class="na">getArray</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
<span class="cm">/* 041 */</span>
<span class="cm">/* 042 */</span>       <span class="kt">int</span> <span class="n">rdd_value_0</span> <span class="o">=</span> <span class="n">rdd_row_0</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="cm">/* 043 */</span>       <span class="kt">boolean</span> <span class="n">project_isNull_3</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
<span class="cm">/* 044 */</span>       <span class="nc">ArrayData</span> <span class="n">project_value_3</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="cm">/* 045 */</span>
<span class="cm">/* 046 */</span>       <span class="k">if</span> <span class="o">(!</span><span class="n">rdd_isNull_1</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 047 */</span>         <span class="k">if</span> <span class="o">(!</span><span class="n">rdd_isNull_2</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 048 */</span>           <span class="n">project_isNull_3</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// resultCode could change nullability.</span>
<span class="cm">/* 049 */</span>           <span class="kt">double</span> <span class="n">project_value_3_x</span> <span class="o">=</span> <span class="n">rdd_value_1</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">rdd_value_2</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="cm">/* 050 */</span>           <span class="kt">double</span> <span class="n">project_value_3_y</span> <span class="o">=</span> <span class="n">rdd_value_1</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">rdd_value_2</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="cm">/* 051 */</span>           <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">myfunctions</span><span class="o">.</span><span class="na">my_point</span> <span class="n">project_value_3_p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">myfunctions</span><span class="o">.</span><span class="na">my_point</span><span class="o">(</span><span class="n">project_value_3_x</span><span class="o">,</span> <span class="n">project_value_3_y</span><span class="o">);</span>
<span class="cm">/* 052 */</span>           <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">myfunctions</span><span class="o">.</span><span class="na">my_point_udt</span> <span class="n">project_value_3_u</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">myfunctions</span><span class="o">.</span><span class="na">my_point_udt</span><span class="o">();</span>
<span class="cm">/* 053 */</span>           <span class="n">project_value_3</span> <span class="o">=</span> <span class="n">project_value_3_u</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">project_value_3_p</span><span class="o">);</span>
<span class="cm">/* 054 */</span>
<span class="cm">/* 055 */</span>         <span class="o">}</span>
<span class="cm">/* 056 */</span>
<span class="cm">/* 057 */</span>       <span class="o">}</span>
<span class="cm">/* 058 */</span>       <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">reset</span><span class="o">();</span>
<span class="cm">/* 059 */</span>
<span class="cm">/* 060 */</span>       <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">zeroOutNullBytes</span><span class="o">();</span>
<span class="cm">/* 061 */</span>
<span class="cm">/* 062 */</span>       <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">write</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">rdd_value_0</span><span class="o">);</span>
<span class="cm">/* 063 */</span>
<span class="cm">/* 064 */</span>       <span class="k">if</span> <span class="o">(</span><span class="n">rdd_isNull_1</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 065 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setNullAt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="cm">/* 066 */</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 067 */</span>         <span class="c1">// Remember the current cursor so that we can calculate how many bytes are</span>
<span class="cm">/* 068 */</span>         <span class="c1">// written later.</span>
<span class="cm">/* 069 */</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_previousCursor_0</span> <span class="o">=</span> <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">cursor</span><span class="o">();</span>
<span class="cm">/* 070 */</span>
<span class="cm">/* 071 */</span>         <span class="kd">final</span> <span class="nc">ArrayData</span> <span class="n">project_tmpInput_0</span> <span class="o">=</span> <span class="n">rdd_value_1</span><span class="o">;</span>
<span class="cm">/* 072 */</span>         <span class="k">if</span> <span class="o">(</span><span class="n">project_tmpInput_0</span> <span class="k">instanceof</span> <span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 073 */</span>           <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">write</span><span class="o">((</span><span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="n">project_tmpInput_0</span><span class="o">);</span>
<span class="cm">/* 074 */</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 075 */</span>           <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_numElements_0</span> <span class="o">=</span> <span class="n">project_tmpInput_0</span><span class="o">.</span><span class="na">numElements</span><span class="o">();</span>
<span class="cm">/* 076 */</span>           <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">initialize</span><span class="o">(</span><span class="n">project_numElements_0</span><span class="o">);</span>
<span class="cm">/* 077 */</span>
<span class="cm">/* 078 */</span>           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">project_index_0</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">project_index_0</span> <span class="o">&lt;</span> <span class="n">project_numElements_0</span><span class="o">;</span> <span class="n">project_index_0</span><span class="o">++)</span> <span class="o">{</span>
<span class="cm">/* 079 */</span>             <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">write</span><span class="o">(</span><span class="n">project_index_0</span><span class="o">,</span> <span class="n">project_tmpInput_0</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="n">project_index_0</span><span class="o">));</span>
<span class="cm">/* 080 */</span>           <span class="o">}</span>
<span class="cm">/* 081 */</span>         <span class="o">}</span>
<span class="cm">/* 082 */</span>
<span class="cm">/* 083 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setOffsetAndSizeFromPreviousCursor</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">project_previousCursor_0</span><span class="o">);</span>
<span class="cm">/* 084 */</span>       <span class="o">}</span>
<span class="cm">/* 085 */</span>
<span class="cm">/* 086 */</span>       <span class="k">if</span> <span class="o">(</span><span class="n">rdd_isNull_2</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 087 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setNullAt</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="cm">/* 088 */</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 089 */</span>         <span class="c1">// Remember the current cursor so that we can calculate how many bytes are</span>
<span class="cm">/* 090 */</span>         <span class="c1">// written later.</span>
<span class="cm">/* 091 */</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_previousCursor_1</span> <span class="o">=</span> <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">cursor</span><span class="o">();</span>
<span class="cm">/* 092 */</span>
<span class="cm">/* 093 */</span>         <span class="kd">final</span> <span class="nc">ArrayData</span> <span class="n">project_tmpInput_1</span> <span class="o">=</span> <span class="n">rdd_value_2</span><span class="o">;</span>
<span class="cm">/* 094 */</span>         <span class="k">if</span> <span class="o">(</span><span class="n">project_tmpInput_1</span> <span class="k">instanceof</span> <span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 095 */</span>           <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">write</span><span class="o">((</span><span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="n">project_tmpInput_1</span><span class="o">);</span>
<span class="cm">/* 096 */</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 097 */</span>           <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_numElements_1</span> <span class="o">=</span> <span class="n">project_tmpInput_1</span><span class="o">.</span><span class="na">numElements</span><span class="o">();</span>
<span class="cm">/* 098 */</span>           <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">3</span><span class="o">].</span><span class="na">initialize</span><span class="o">(</span><span class="n">project_numElements_1</span><span class="o">);</span>
<span class="cm">/* 099 */</span>
<span class="cm">/* 100 */</span>           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">project_index_1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">project_index_1</span> <span class="o">&lt;</span> <span class="n">project_numElements_1</span><span class="o">;</span> <span class="n">project_index_1</span><span class="o">++)</span> <span class="o">{</span>
<span class="cm">/* 101 */</span>             <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">3</span><span class="o">].</span><span class="na">write</span><span class="o">(</span><span class="n">project_index_1</span><span class="o">,</span> <span class="n">project_tmpInput_1</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="n">project_index_1</span><span class="o">));</span>
<span class="cm">/* 102 */</span>           <span class="o">}</span>
<span class="cm">/* 103 */</span>         <span class="o">}</span>
<span class="cm">/* 104 */</span>
<span class="cm">/* 105 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setOffsetAndSizeFromPreviousCursor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">project_previousCursor_1</span><span class="o">);</span>
<span class="cm">/* 106 */</span>       <span class="o">}</span>
<span class="cm">/* 107 */</span>
<span class="cm">/* 108 */</span>       <span class="k">if</span> <span class="o">(</span><span class="n">project_isNull_3</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 109 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setNullAt</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
<span class="cm">/* 110 */</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 111 */</span>         <span class="c1">// Remember the current cursor so that we can calculate how many bytes are</span>
<span class="cm">/* 112 */</span>         <span class="c1">// written later.</span>
<span class="cm">/* 113 */</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_previousCursor_2</span> <span class="o">=</span> <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">cursor</span><span class="o">();</span>
<span class="cm">/* 114 */</span>
<span class="cm">/* 115 */</span>         <span class="kd">final</span> <span class="nc">ArrayData</span> <span class="n">project_tmpInput_2</span> <span class="o">=</span> <span class="n">project_value_3</span><span class="o">;</span>
<span class="cm">/* 116 */</span>         <span class="k">if</span> <span class="o">(</span><span class="n">project_tmpInput_2</span> <span class="k">instanceof</span> <span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 117 */</span>           <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">write</span><span class="o">((</span><span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="n">project_tmpInput_2</span><span class="o">);</span>
<span class="cm">/* 118 */</span>         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 119 */</span>           <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_numElements_2</span> <span class="o">=</span> <span class="n">project_tmpInput_2</span><span class="o">.</span><span class="na">numElements</span><span class="o">();</span>
<span class="cm">/* 120 */</span>           <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">4</span><span class="o">].</span><span class="na">initialize</span><span class="o">(</span><span class="n">project_numElements_2</span><span class="o">);</span>
<span class="cm">/* 121 */</span>
<span class="cm">/* 122 */</span>           <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">project_index_2</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">project_index_2</span> <span class="o">&lt;</span> <span class="n">project_numElements_2</span><span class="o">;</span> <span class="n">project_index_2</span><span class="o">++)</span> <span class="o">{</span>
<span class="cm">/* 123 */</span>             <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">4</span><span class="o">].</span><span class="na">write</span><span class="o">(</span><span class="n">project_index_2</span><span class="o">,</span> <span class="n">project_tmpInput_2</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="n">project_index_2</span><span class="o">));</span>
<span class="cm">/* 124 */</span>           <span class="o">}</span>
<span class="cm">/* 125 */</span>         <span class="o">}</span>
<span class="cm">/* 126 */</span>
<span class="cm">/* 127 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setOffsetAndSizeFromPreviousCursor</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">project_previousCursor_2</span><span class="o">);</span>
<span class="cm">/* 128 */</span>       <span class="o">}</span>
<span class="cm">/* 129 */</span>       <span class="n">append</span><span class="o">((</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">getRow</span><span class="o">()));</span>
<span class="cm">/* 130 */</span>       <span class="k">if</span> <span class="o">(</span><span class="n">shouldStop</span><span class="o">())</span> <span class="k">return</span><span class="o">;</span>
<span class="cm">/* 131 */</span>     <span class="o">}</span>
<span class="cm">/* 132 */</span>   <span class="o">}</span>
<span class="cm">/* 133 */</span>
<span class="cm">/* 134 */</span> <span class="o">}</span>
</pre></table></code></div></div><p>其中 <code class="language-plaintext highlighter-rouge">46~57</code> 包含 <code class="language-plaintext highlighter-rouge">my_foo</code> 对空值的处理，程序输出结果如下：</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>+---+----------+------------+----------------------+
|idx|    point1|      point2|my_foo(point1, point2)|
+---+----------+------------+----------------------+
|  1|(1.0, 1.0)|(10.0, 10.0)|          (11.0, 11.0)|
|  2|(2.0, 2.0)|(20.0, 20.0)|          (22.0, 22.0)|
|  3|      null|(30.0, 30.0)|                  null|
|  4|(4.0, 4.0)|        null|                  null|
|  5|      null|        null|                  null|
+---+----------+------------+----------------------+
</pre></table></code></div></div><p>不处理 <code class="language-plaintext highlighter-rouge">null</code> 的 Codegen 代码如下，其中 <code class="language-plaintext highlighter-rouge">39 ~ 43</code> 为 <code class="language-plaintext highlighter-rouge">my_foo</code> 的核心代码</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre><td class="rouge-code"><pre><span class="cm">/* 001 */</span> <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">generate</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">references</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 002 */</span>   <span class="k">return</span> <span class="k">new</span> <span class="nc">GeneratedIteratorForCodegenStage1</span><span class="o">(</span><span class="n">references</span><span class="o">);</span>
<span class="cm">/* 003 */</span> <span class="o">}</span>
<span class="cm">/* 004 */</span>
<span class="cm">/* 005 */</span> <span class="c1">// codegenStageId=1</span>
<span class="cm">/* 006 */</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">GeneratedIteratorForCodegenStage1</span> <span class="kd">extends</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">BufferedRowIterator</span> <span class="o">{</span>
<span class="cm">/* 007 */</span>   <span class="kd">private</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">references</span><span class="o">;</span>
<span class="cm">/* 008 */</span>   <span class="kd">private</span> <span class="n">scala</span><span class="o">.</span><span class="na">collection</span><span class="o">.</span><span class="na">Iterator</span><span class="o">[]</span> <span class="n">inputs</span><span class="o">;</span>
<span class="cm">/* 009 */</span>   <span class="kd">private</span> <span class="n">scala</span><span class="o">.</span><span class="na">collection</span><span class="o">.</span><span class="na">Iterator</span> <span class="n">rdd_input_0</span><span class="o">;</span>
<span class="cm">/* 010 */</span>   <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeRowWriter</span><span class="o">[]</span> <span class="n">rdd_mutableStateArray_0</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeRowWriter</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
<span class="cm">/* 011 */</span>   <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">[]</span> <span class="n">rdd_mutableStateArray_1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">[</span><span class="mi">5</span><span class="o">];</span>
<span class="cm">/* 012 */</span>
<span class="cm">/* 013 */</span>   <span class="kd">public</span> <span class="nf">GeneratedIteratorForCodegenStage1</span><span class="o">(</span><span class="nc">Object</span><span class="o">[]</span> <span class="n">references</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 014 */</span>     <span class="k">this</span><span class="o">.</span><span class="na">references</span> <span class="o">=</span> <span class="n">references</span><span class="o">;</span>
<span class="cm">/* 015 */</span>   <span class="o">}</span>
<span class="cm">/* 016 */</span>
<span class="cm">/* 017 */</span>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">scala</span><span class="o">.</span><span class="na">collection</span><span class="o">.</span><span class="na">Iterator</span><span class="o">[]</span> <span class="n">inputs</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 018 */</span>     <span class="n">partitionIndex</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
<span class="cm">/* 019 */</span>     <span class="k">this</span><span class="o">.</span><span class="na">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">;</span>
<span class="cm">/* 020 */</span>     <span class="n">rdd_input_0</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
<span class="cm">/* 021 */</span>     <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeRowWriter</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">64</span><span class="o">);</span>
<span class="cm">/* 022 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 023 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 024 */</span>     <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeRowWriter</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">96</span><span class="o">);</span>
<span class="cm">/* 025 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 026 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 027 */</span>     <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">catalyst</span><span class="o">.</span><span class="na">expressions</span><span class="o">.</span><span class="na">codegen</span><span class="o">.</span><span class="na">UnsafeArrayWriter</span><span class="o">(</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="mi">8</span><span class="o">);</span>
<span class="cm">/* 028 */</span>
<span class="cm">/* 029 */</span>   <span class="o">}</span>
<span class="cm">/* 030 */</span>
<span class="cm">/* 031 */</span>   <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">processNext</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
<span class="cm">/* 032 */</span>     <span class="k">while</span> <span class="o">(</span> <span class="n">rdd_input_0</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
<span class="cm">/* 033 */</span>       <span class="nc">InternalRow</span> <span class="n">rdd_row_0</span> <span class="o">=</span> <span class="o">(</span><span class="nc">InternalRow</span><span class="o">)</span> <span class="n">rdd_input_0</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
<span class="cm">/* 034 */</span>       <span class="o">((</span><span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">execution</span><span class="o">.</span><span class="na">metric</span><span class="o">.</span><span class="na">SQLMetric</span><span class="o">)</span> <span class="n">references</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="cm">/* numOutputRows */</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="cm">/* 035 */</span>       <span class="nc">ArrayData</span> <span class="n">rdd_value_1</span> <span class="o">=</span> <span class="n">rdd_row_0</span><span class="o">.</span><span class="na">getArray</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="cm">/* 036 */</span>       <span class="nc">ArrayData</span> <span class="n">rdd_value_2</span> <span class="o">=</span> <span class="n">rdd_row_0</span><span class="o">.</span><span class="na">getArray</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
<span class="cm">/* 037 */</span>
<span class="cm">/* 038 */</span>       <span class="kt">int</span> <span class="n">rdd_value_0</span> <span class="o">=</span> <span class="n">rdd_row_0</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="cm">/* 039 */</span>       <span class="kt">double</span> <span class="n">project_value_3_x</span> <span class="o">=</span> <span class="n">rdd_value_1</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">rdd_value_2</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
<span class="cm">/* 040 */</span>       <span class="kt">double</span> <span class="n">project_value_3_y</span> <span class="o">=</span> <span class="n">rdd_value_1</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">rdd_value_2</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="cm">/* 041 */</span>       <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">myfunctions</span><span class="o">.</span><span class="na">my_point</span> <span class="n">project_value_3_p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">myfunctions</span><span class="o">.</span><span class="na">my_point</span><span class="o">(</span><span class="n">project_value_3_x</span><span class="o">,</span> <span class="n">project_value_3_y</span><span class="o">);</span>
<span class="cm">/* 042 */</span>       <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">myfunctions</span><span class="o">.</span><span class="na">my_point_udt</span> <span class="n">project_value_3_u</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">apache</span><span class="o">.</span><span class="na">spark</span><span class="o">.</span><span class="na">sql</span><span class="o">.</span><span class="na">myfunctions</span><span class="o">.</span><span class="na">my_point_udt</span><span class="o">();</span>
<span class="cm">/* 043 */</span>       <span class="nc">ArrayData</span> <span class="n">project_value_3</span> <span class="o">=</span> <span class="n">project_value_3_u</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">project_value_3_p</span><span class="o">);</span>
<span class="cm">/* 044 */</span>       <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">reset</span><span class="o">();</span>
<span class="cm">/* 045 */</span>
<span class="cm">/* 046 */</span>       <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">write</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">rdd_value_0</span><span class="o">);</span>
<span class="cm">/* 047 */</span>
<span class="cm">/* 048 */</span>       <span class="c1">// Remember the current cursor so that we can calculate how many bytes are</span>
<span class="cm">/* 049 */</span>       <span class="c1">// written later.</span>
<span class="cm">/* 050 */</span>       <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_previousCursor_0</span> <span class="o">=</span> <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">cursor</span><span class="o">();</span>
<span class="cm">/* 051 */</span>
<span class="cm">/* 052 */</span>       <span class="kd">final</span> <span class="nc">ArrayData</span> <span class="n">project_tmpInput_0</span> <span class="o">=</span> <span class="n">rdd_value_1</span><span class="o">;</span>
<span class="cm">/* 053 */</span>       <span class="k">if</span> <span class="o">(</span><span class="n">project_tmpInput_0</span> <span class="k">instanceof</span> <span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 054 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">write</span><span class="o">((</span><span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="n">project_tmpInput_0</span><span class="o">);</span>
<span class="cm">/* 055 */</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 056 */</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_numElements_0</span> <span class="o">=</span> <span class="n">project_tmpInput_0</span><span class="o">.</span><span class="na">numElements</span><span class="o">();</span>
<span class="cm">/* 057 */</span>         <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">initialize</span><span class="o">(</span><span class="n">project_numElements_0</span><span class="o">);</span>
<span class="cm">/* 058 */</span>
<span class="cm">/* 059 */</span>         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">project_index_0</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">project_index_0</span> <span class="o">&lt;</span> <span class="n">project_numElements_0</span><span class="o">;</span> <span class="n">project_index_0</span><span class="o">++)</span> <span class="o">{</span>
<span class="cm">/* 060 */</span>           <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="na">write</span><span class="o">(</span><span class="n">project_index_0</span><span class="o">,</span> <span class="n">project_tmpInput_0</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="n">project_index_0</span><span class="o">));</span>
<span class="cm">/* 061 */</span>         <span class="o">}</span>
<span class="cm">/* 062 */</span>       <span class="o">}</span>
<span class="cm">/* 063 */</span>
<span class="cm">/* 064 */</span>       <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setOffsetAndSizeFromPreviousCursor</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">project_previousCursor_0</span><span class="o">);</span>
<span class="cm">/* 065 */</span>
<span class="cm">/* 066 */</span>       <span class="c1">// Remember the current cursor so that we can calculate how many bytes are</span>
<span class="cm">/* 067 */</span>       <span class="c1">// written later.</span>
<span class="cm">/* 068 */</span>       <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_previousCursor_1</span> <span class="o">=</span> <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">cursor</span><span class="o">();</span>
<span class="cm">/* 069 */</span>
<span class="cm">/* 070 */</span>       <span class="kd">final</span> <span class="nc">ArrayData</span> <span class="n">project_tmpInput_1</span> <span class="o">=</span> <span class="n">rdd_value_2</span><span class="o">;</span>
<span class="cm">/* 071 */</span>       <span class="k">if</span> <span class="o">(</span><span class="n">project_tmpInput_1</span> <span class="k">instanceof</span> <span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 072 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">write</span><span class="o">((</span><span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="n">project_tmpInput_1</span><span class="o">);</span>
<span class="cm">/* 073 */</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 074 */</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_numElements_1</span> <span class="o">=</span> <span class="n">project_tmpInput_1</span><span class="o">.</span><span class="na">numElements</span><span class="o">();</span>
<span class="cm">/* 075 */</span>         <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">3</span><span class="o">].</span><span class="na">initialize</span><span class="o">(</span><span class="n">project_numElements_1</span><span class="o">);</span>
<span class="cm">/* 076 */</span>
<span class="cm">/* 077 */</span>         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">project_index_1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">project_index_1</span> <span class="o">&lt;</span> <span class="n">project_numElements_1</span><span class="o">;</span> <span class="n">project_index_1</span><span class="o">++)</span> <span class="o">{</span>
<span class="cm">/* 078 */</span>           <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">3</span><span class="o">].</span><span class="na">write</span><span class="o">(</span><span class="n">project_index_1</span><span class="o">,</span> <span class="n">project_tmpInput_1</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="n">project_index_1</span><span class="o">));</span>
<span class="cm">/* 079 */</span>         <span class="o">}</span>
<span class="cm">/* 080 */</span>       <span class="o">}</span>
<span class="cm">/* 081 */</span>
<span class="cm">/* 082 */</span>       <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setOffsetAndSizeFromPreviousCursor</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">project_previousCursor_1</span><span class="o">);</span>
<span class="cm">/* 083 */</span>
<span class="cm">/* 084 */</span>       <span class="c1">// Remember the current cursor so that we can calculate how many bytes are</span>
<span class="cm">/* 085 */</span>       <span class="c1">// written later.</span>
<span class="cm">/* 086 */</span>       <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_previousCursor_2</span> <span class="o">=</span> <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">cursor</span><span class="o">();</span>
<span class="cm">/* 087 */</span>
<span class="cm">/* 088 */</span>       <span class="kd">final</span> <span class="nc">ArrayData</span> <span class="n">project_tmpInput_2</span> <span class="o">=</span> <span class="n">project_value_3</span><span class="o">;</span>
<span class="cm">/* 089 */</span>       <span class="k">if</span> <span class="o">(</span><span class="n">project_tmpInput_2</span> <span class="k">instanceof</span> <span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/* 090 */</span>         <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">write</span><span class="o">((</span><span class="nc">UnsafeArrayData</span><span class="o">)</span> <span class="n">project_tmpInput_2</span><span class="o">);</span>
<span class="cm">/* 091 */</span>       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="cm">/* 092 */</span>         <span class="kd">final</span> <span class="kt">int</span> <span class="n">project_numElements_2</span> <span class="o">=</span> <span class="n">project_tmpInput_2</span><span class="o">.</span><span class="na">numElements</span><span class="o">();</span>
<span class="cm">/* 093 */</span>         <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">4</span><span class="o">].</span><span class="na">initialize</span><span class="o">(</span><span class="n">project_numElements_2</span><span class="o">);</span>
<span class="cm">/* 094 */</span>
<span class="cm">/* 095 */</span>         <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">project_index_2</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">project_index_2</span> <span class="o">&lt;</span> <span class="n">project_numElements_2</span><span class="o">;</span> <span class="n">project_index_2</span><span class="o">++)</span> <span class="o">{</span>
<span class="cm">/* 096 */</span>           <span class="n">rdd_mutableStateArray_1</span><span class="o">[</span><span class="mi">4</span><span class="o">].</span><span class="na">write</span><span class="o">(</span><span class="n">project_index_2</span><span class="o">,</span> <span class="n">project_tmpInput_2</span><span class="o">.</span><span class="na">getDouble</span><span class="o">(</span><span class="n">project_index_2</span><span class="o">));</span>
<span class="cm">/* 097 */</span>         <span class="o">}</span>
<span class="cm">/* 098 */</span>       <span class="o">}</span>
<span class="cm">/* 099 */</span>
<span class="cm">/* 100 */</span>       <span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">setOffsetAndSizeFromPreviousCursor</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">project_previousCursor_2</span><span class="o">);</span>
<span class="cm">/* 101 */</span>       <span class="n">append</span><span class="o">((</span><span class="n">rdd_mutableStateArray_0</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">getRow</span><span class="o">()));</span>
<span class="cm">/* 102 */</span>       <span class="k">if</span> <span class="o">(</span><span class="n">shouldStop</span><span class="o">())</span> <span class="k">return</span><span class="o">;</span>
<span class="cm">/* 103 */</span>     <span class="o">}</span>
<span class="cm">/* 104 */</span>   <span class="o">}</span>
<span class="cm">/* 105 */</span>
<span class="cm">/* 106 */</span> <span class="o">}</span>
</pre></table></code></div></div><p>程序输出效果如下：</p><div class="language-text highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>+---+----------+------------+----------------------+
|idx|    point1|      point2|my_foo(point1, point2)|
+---+----------+------------+----------------------+
|  1|(1.0, 1.0)|(10.0, 10.0)|          (11.0, 11.0)|
|  2|(2.0, 2.0)|(20.0, 20.0)|          (22.0, 22.0)|
|  3|(3.0, 3.0)|(30.0, 30.0)|          (33.0, 33.0)|
|  4|(4.0, 4.0)|(40.0, 40.0)|          (44.0, 44.0)|
|  5|(5.0, 5.0)|(50.0, 50.0)|          (55.0, 55.0)|
+---+----------+------------+----------------------+
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/spark/'>spark</a>, <a href='/categories/codegen/'>codegen</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/spark-codegen/" class="post-tag no-text-decoration" >spark-codegen</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=9-自定义数据类型上的 Codegen - I have a adream&url=https://adream307.github.io/posts/udt_codegen/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=9-自定义数据类型上的 Codegen - I have a adream&u=https://adream307.github.io/posts/udt_codegen/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=9-自定义数据类型上的 Codegen - I have a adream&url=https://adream307.github.io/posts/udt_codegen/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/getting-started/">Getting Started</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/spark-codegen/">spark-codegen</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/etcd/">etcd</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/c-11/">c++11</a> <a class="post-tag" href="/tags/cuda/">cuda</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/new_spark_sql_project/"><div class="card-body"> <span class="timeago small" > Jun 1, 2020 <i class="unloaded">2020-06-01T08:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>1-新建一个 Spark SQL 的工程</h3><div class="text-muted small"><p> 本文介绍如何新建一个 Spark SQL 的例子，Spark 采用 standalone 的 local 模式, 需要安装 scala 本文所演示的例子位于 https://github.com/adream307/SparkSQLWithCodegen/tree/master/code/new_spark_sql_project 目录内 新建目录结构 Spark SQL 工程的目录结构...</p></div></div></a></div><div class="card"> <a href="/posts/show_codegen_code/"><div class="card-body"> <span class="timeago small" > Jun 2, 2020 <i class="unloaded">2020-06-02T08:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>2-显示 Codegen 代码</h3><div class="text-muted small"><p> 在上一篇文章中，我们演示了如何新建一个 Spark SQL 的工程，并展示了一个简单的 SQL 查询 select x, y, power(x,y) from data_test 文章 Deep Dive into Spark SQL’s Catalyst Optimizer 详细介绍了 Spark SQL 的优化机制。为了提高查询速度，Spark 会将查询的 SQL 语句动态生成一份对...</p></div></div></a></div><div class="card"> <a href="/posts/udf_example1/"><div class="card-body"> <span class="timeago small" > Jun 3, 2020 <i class="unloaded">2020-06-03T08:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>3-自定义函数示例1</h3><div class="text-muted small"><p> Spark 原生提供UDF用于实现自定义函数 UDF 示例 假设我们的需求是这样的： 需要一个名字为 my_foo 的函数 该函数接受两个 double 类型的参数作为输入 参数名记为 x，y 函数输出 x*y+3 为了实现上述功能，我们在程序中定义了 my_foo 匿名函数，并向 spark 注册 udf，完整代码位于 https://github.com/adr...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/udt_udf_example/" class="btn btn-outline-primary"><p>8-自定义数据类型上的自定义函数</p></a> <a href="/posts/zap-with-logrotate/" class="btn btn-outline-primary"><p>zap配合logrotate实现日志滚动</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/adream307">adream307</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/spark-codegen/">spark codegen</a> <a class="post-tag" href="/tags/go/">go</a> <a class="post-tag" href="/tags/etcd/">etcd</a> <a class="post-tag" href="/tags/git/">git</a> <a class="post-tag" href="/tags/aws/">aws</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/ssh/">ssh</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/c-11/">c++11</a> <a class="post-tag" href="/tags/cuda/">cuda</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://adream307.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
